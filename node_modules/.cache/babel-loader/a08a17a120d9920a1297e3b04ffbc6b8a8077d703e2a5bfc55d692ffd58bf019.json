{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Paul2\\\\onedrive\\\\\\u684C\\u9762\\\\llm_dialougue_v4\\\\wingchat-app\\\\src\\\\components\\\\TrainingRoom\\\\TrainingRoom.js\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef, useCallback } from 'react';\nimport { Form, InputGroup, Container, Row, Col, Spinner, Alert, Button } from 'react-bootstrap';\nimport ChatDisplay from './ChatDisplay';\nimport MessageInput from './MessageInput';\nimport { sendMessageToOllama, getFeedbackFromOllama } from '../../services/ollamaService'; // 引入 API 服務\nimport '../../styles/TrainingRoom.css'; // 引入聊天室樣式\n\n// 本地儲存聊天記錄的 Key 前綴\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst CHAT_HISTORY_PREFIX = 'wingchat_history_';\n// 本地儲存回饋的 Key (雖然解析還未完成，但先定義)\nconst FEEDBACK_STORAGE_KEY = 'wingchat_feedback';\nfunction TrainingRoom({\n  selectedCharacter\n}) {\n  _s();\n  const [goal, setGoal] = useState('');\n  const [messages, setMessages] = useState([]);\n  const [currentMessage, setCurrentMessage] = useState('');\n  const [isLoading, setIsLoading] = useState(false);\n  const [isGettingFeedback, setIsGettingFeedback] = useState(false);\n  const [error, setError] = useState(null);\n  const currentGoalRef = useRef(goal);\n\n  // 產生用於儲存的 key\n  const getStorageKey = useCallback(() => {\n    if (!selectedCharacter || !goal.trim()) return null;\n    const goalKey = goal.trim().substring(0, 50).replace(/[^a-zA-Z0-9-_]/g, '_'); // 允許底線和連字號\n    return `${CHAT_HISTORY_PREFIX}${selectedCharacter.id}_${goalKey}`;\n  }, [selectedCharacter, goal]);\n\n  // 加載聊天記錄\n  useEffect(() => {\n    currentGoalRef.current = goal;\n    const storageKey = getStorageKey();\n    if (storageKey) {\n      const savedHistory = localStorage.getItem(storageKey);\n      if (savedHistory) {\n        try {\n          setMessages(JSON.parse(savedHistory));\n        } catch (e) {\n          console.error(\"Failed to parse chat history\", e);\n          setMessages([]);\n        }\n      } else {\n        setMessages([]);\n      }\n    } else if (selectedCharacter) {\n      setMessages([]);\n    }\n    setError(null);\n  }, [selectedCharacter, goal, getStorageKey]);\n\n  // 保存聊天記錄\n  useEffect(() => {\n    const storageKey = getStorageKey();\n    if (storageKey && messages.length > 0) {\n      localStorage.setItem(storageKey, JSON.stringify(messages));\n    } else if (storageKey && messages.length === 0) {\n      localStorage.removeItem(storageKey);\n    }\n  }, [messages, getStorageKey]);\n\n  // 清除當前目標的聊天記錄\n  const handleClearChat = () => {\n    if (window.confirm(`確定要清除與 ${selectedCharacter === null || selectedCharacter === void 0 ? void 0 : selectedCharacter.name} 關於目標「${goal}」的所有聊天記錄嗎？`)) {\n      setMessages([]);\n      const storageKey = getStorageKey();\n      if (storageKey) {\n        localStorage.removeItem(storageKey);\n      }\n    }\n  };\n\n  // 發送訊息處理\n  const handleSendMessage = async () => {\n    if (!currentMessage.trim() || !selectedCharacter) return;\n    if (!goal.trim()) {\n      setError(\"請先設定本次聊天的目標！\");\n      return;\n    }\n    if (isLoading || isGettingFeedback) return;\n    const newUserMessage = {\n      id: Date.now(),\n      sender: 'user',\n      text: currentMessage\n    };\n    const currentInput = currentMessage;\n    // 立即更新 UI\n    setMessages(prevMessages => [...prevMessages, newUserMessage]);\n    setCurrentMessage('');\n    setIsLoading(true);\n    setError(null);\n    try {\n      const historyForOllama = messages.map(msg => ({\n        role: msg.sender === 'user' ? 'user' : 'assistant',\n        content: msg.text\n      }));\n      // 使用最新的 user message (currentInput) 構建傳遞給 API 的歷史\n      const requestHistory = [...historyForOllama, {\n        role: 'user',\n        content: currentInput\n      }];\n      const aiResponseText = await sendMessageToOllama(goal, requestHistory,\n      // 使用包含最新消息的歷史\n      selectedCharacter, \"llama3.2:latest\" // <--- 確認使用新模型名稱\n      );\n      const newAiMessage = {\n        id: Date.now() + 1,\n        sender: 'ai',\n        text: aiResponseText\n      };\n      // 注意：這裡的 setMessages 是基於「請求發起時」的 messages 狀態來添加 AI 回覆\n      // 為了確保 user message 肯定在 AI message 之前，我們直接添加在 newUserMessage 之後\n      setMessages(prevMessages => [...prevMessages, newAiMessage]);\n    } catch (err) {\n      console.error(\"Error contacting Ollama:\", err);\n      const errorMsg = err.message || \"與 AI 通訊時發生錯誤。\";\n      setError(errorMsg);\n      const errorAiMessage = {\n        id: Date.now() + 1,\n        sender: 'ai',\n        text: `🤖 抱歉，處理時遇到問題：${errorMsg}`\n      };\n      // 同樣，添加在最新的 user message 之後\n      setMessages(prevMessages => [...prevMessages, errorAiMessage]);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  // --- TODO: 回饋解析函數 ---\n  // 這個函數需要根據 getFeedbackFromOllama 返回的字串格式來解析\n  const parseFeedback = feedbackText => {\n    let summary = \"無法解析回饋摘要。\";\n    let scores = {\n      clarity: null,\n      empathy: null,\n      confidence: null,\n      appropriateness: null,\n      goalAchievement: null\n    };\n    try {\n      // 解析摘要\n      const summaryMatch = feedbackText.match(/\\[Feedback Summary\\]\\s*([\\s\\S]*?)\\s*\\[Scores\\]/);\n      if (summaryMatch && summaryMatch[1]) {\n        summary = summaryMatch[1].trim();\n      } else {\n        // 嘗試備用模式，如果沒有 [Scores] 標籤\n        const summaryOnlyMatch = feedbackText.match(/\\[Feedback Summary\\]\\s*([\\s\\S]*)/);\n        if (summaryOnlyMatch && summaryOnlyMatch[1]) {\n          summary = summaryOnlyMatch[1].trim();\n          console.warn(\"Feedback parsing: Only found summary, scores section missing or malformed.\");\n        } else {\n          console.warn(\"Feedback parsing: Could not find [Feedback Summary] section.\");\n          // 如果連摘要都找不到，可能整個回饋都是非結構化的\n          summary = feedbackText; // 將整個文本視為摘要\n        }\n      }\n\n      // 解析分數\n      const scoresTextMatch = feedbackText.match(/\\[Scores\\]\\s*([\\s\\S]*)/);\n      if (scoresTextMatch && scoresTextMatch[1]) {\n        const scoreLines = scoresTextMatch[1].trim().split('\\n');\n        scoreLines.forEach(line => {\n          const parts = line.split(':');\n          if (parts.length === 2) {\n            const key = parts[0].trim().toLowerCase().replace(/\\s+/g, ''); // 轉小寫並移除空格\n            const value = parts[1].trim();\n            if (value.toLowerCase() === 'n/a') {\n              scores[key] = null; // N/A 視為 null\n            } else {\n              const score = parseInt(value, 10);\n              if (!isNaN(score)) {\n                if (key === 'clarity') scores.clarity = Math.max(0, Math.min(100, score));else if (key === 'empathy') scores.empathy = Math.max(0, Math.min(100, score));else if (key === 'confidence') scores.confidence = Math.max(0, Math.min(100, score));else if (key === 'appropriateness') scores.appropriateness = Math.max(0, Math.min(100, score));else if (key === 'goalachievement') scores.goalAchievement = Math.max(0, Math.min(100, score));\n              }\n            }\n          }\n        });\n      } else if (!summaryOnlyMatch) {\n        // 如果連 [Scores] 都沒匹配到，且不是只有摘要的情況\n        console.warn(\"Feedback parsing: Could not find [Scores] section.\");\n      }\n    } catch (e) {\n      console.error(\"Error parsing feedback text:\", e);\n      // 出錯時返回原始文本作為摘要，分數為空\n      summary = feedbackText;\n    }\n    console.log(\"Parsed Feedback:\", {\n      summary,\n      scores\n    });\n    return {\n      summary,\n      scores\n    };\n  };\n  // --- 結束 TODO ---\n\n  // 獲取回饋處理\n  const handleGetFeedback = async () => {\n    if (!selectedCharacter || !goal.trim() || messages.filter(m => m.sender !== 'system').length === 0) {\n      // 確保有非系統消息\n      alert(\"請先設定目標、選擇角色並進行至少一輪對話，才能請求回饋。\");\n      return;\n    }\n    if (isLoading || isGettingFeedback) return;\n    setIsGettingFeedback(true);\n    setError(null);\n    const feedbackRequestMessage = {\n      id: Date.now(),\n      sender: 'system',\n      text: '⏳ 正在向 AI 請求對話回饋...'\n    };\n    setMessages(prevMessages => [...prevMessages, feedbackRequestMessage]);\n    try {\n      var _scores$clarity, _scores$empathy, _scores$confidence, _scores$appropriatene, _scores$goalAchieveme;\n      const historyForFeedback = messages.filter(msg => msg.sender !== 'system') // 過濾掉系統消息\n      .map(msg => ({\n        role: msg.sender === 'user' ? 'user' : 'assistant',\n        content: msg.text\n      }));\n      const feedbackRawText = await getFeedbackFromOllama(goal, historyForFeedback, selectedCharacter, \"llama3.2:latest\" // <--- 確認使用新模型名稱\n      );\n\n      // --- TODO: 解析並儲存回饋 ---\n      const {\n        summary,\n        scores\n      } = parseFeedback(feedbackRawText);\n      const feedbackMessage = {\n        id: Date.now() + 1,\n        sender: 'ai',\n        // 在聊天中顯示結構化的回饋（或僅顯示摘要）\n        text: `💡 **本次對話回饋 (${goal})**\\n\\n**摘要:**\\n${summary}\\n\\n**評分 (0-100):**\\n- 清晰度: ${(_scores$clarity = scores.clarity) !== null && _scores$clarity !== void 0 ? _scores$clarity : 'N/A'}\\n- 同理心: ${(_scores$empathy = scores.empathy) !== null && _scores$empathy !== void 0 ? _scores$empathy : 'N/A'}\\n- 自信: ${(_scores$confidence = scores.confidence) !== null && _scores$confidence !== void 0 ? _scores$confidence : 'N/A'}\\n- 適當性: ${(_scores$appropriatene = scores.appropriateness) !== null && _scores$appropriatene !== void 0 ? _scores$appropriatene : 'N/A'}\\n- 目標達成: ${(_scores$goalAchieveme = scores.goalAchievement) !== null && _scores$goalAchieveme !== void 0 ? _scores$goalAchieveme : 'N/A'}`\n      };\n\n      // 儲存到 localStorage 供 FeedbackWall 使用\n      const newFeedbackEntry = {\n        timestamp: Date.now(),\n        goal: goal,\n        characterId: selectedCharacter.id,\n        characterName: selectedCharacter.name,\n        scores: scores,\n        // 儲存解析後的分數對象\n        summary: summary,\n        // 儲存解析後的摘要\n        rawFeedback: feedbackRawText // (可選) 儲存原始文本供調試\n      };\n      const existingFeedback = JSON.parse(localStorage.getItem(FEEDBACK_STORAGE_KEY) || '[]');\n      localStorage.setItem(FEEDBACK_STORAGE_KEY, JSON.stringify([...existingFeedback, newFeedbackEntry]));\n      // --- 結束 TODO ---\n\n      // 移除\"正在請求\"的訊息，並加入解析後的回饋訊息\n      setMessages(prevMessages => [...prevMessages.filter(msg => msg.id !== feedbackRequestMessage.id), feedbackMessage]);\n    } catch (err) {\n      console.error(\"Error getting or parsing feedback from Ollama:\", err);\n      const errorMsg = err.message || \"無法獲取或處理 AI 回饋。\";\n      setError(errorMsg);\n      const errorFeedbackMessage = {\n        id: Date.now() + 1,\n        sender: 'ai',\n        text: `🤖 抱歉，獲取回饋時遇到問題：${errorMsg}`\n      };\n      setMessages(prevMessages => [...prevMessages.filter(msg => msg.id !== feedbackRequestMessage.id), errorFeedbackMessage]);\n    } finally {\n      setIsGettingFeedback(false);\n    }\n  };\n  return /*#__PURE__*/_jsxDEV(Container, {\n    fluid: true,\n    className: \"training-room-container vh-100\",\n    children: [/*#__PURE__*/_jsxDEV(Row, {\n      className: \"goal-input-row bg-light p-2 mb-2 sticky-top shadow-sm\",\n      children: [/*#__PURE__*/_jsxDEV(Col, {\n        md: 7,\n        children: /*#__PURE__*/_jsxDEV(InputGroup, {\n          children: [/*#__PURE__*/_jsxDEV(InputGroup.Text, {\n            children: \"\\uD83C\\uDFAF\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 292,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(Form.Control, {\n            type: \"text\",\n            placeholder: selectedCharacter ? \"輸入本次社交訓練目標...\" : \"請先選擇角色...\",\n            value: goal,\n            onChange: e => setGoal(e.target.value),\n            disabled: !selectedCharacter || isLoading || isGettingFeedback,\n            \"aria-label\": \"\\u804A\\u5929\\u76EE\\u6A19\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 293,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 291,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 290,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(Col, {\n        md: 5,\n        className: \"d-flex align-items-center justify-content-md-end mt-2 mt-md-0\",\n        children: selectedCharacter ? /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"d-flex align-items-center\",\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"text-muted me-3 text-truncate\",\n            title: `與 ${selectedCharacter.name} 訓練中`,\n            children: [\"\\u8207 \", /*#__PURE__*/_jsxDEV(\"strong\", {\n              children: selectedCharacter.name\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 307,\n              columnNumber: 23\n            }, this), \" \\u8A13\\u7DF4\\u4E2D\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 306,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(Button, {\n            variant: \"outline-secondary\",\n            size: \"sm\",\n            onClick: handleClearChat,\n            disabled: messages.length === 0 || isLoading || isGettingFeedback,\n            title: `清除關於目標 \"${goal}\" 的聊天記錄`,\n            children: [/*#__PURE__*/_jsxDEV(\"i\", {\n              className: \"bi bi-trash3 me-1\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 316,\n              columnNumber: 21\n            }, this), \" \\u6E05\\u9664\\u8A18\\u9304\"]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 309,\n            columnNumber: 17\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 305,\n          columnNumber: 13\n        }, this) : /*#__PURE__*/_jsxDEV(Alert, {\n          variant: \"warning\",\n          className: \"p-1 mb-0 small w-100 text-center\",\n          children: [\"\\u8ACB\\u5148\\u81F3 \", /*#__PURE__*/_jsxDEV(\"a\", {\n            href: \"#\",\n            onClick: e => {\n              e.preventDefault();\n              alert('請點擊上方導覽列的「角色館」');\n            },\n            children: \"\\u89D2\\u8272\\u9928\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 322,\n            columnNumber: 19\n          }, this), \" \\u9078\\u64C7\\u6216\\u65B0\\u589E\\u89D2\\u8272\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 321,\n          columnNumber: 13\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 303,\n        columnNumber: 9\n      }, this), error && /*#__PURE__*/_jsxDEV(Col, {\n        xs: 12,\n        className: \"mt-2\",\n        children: /*#__PURE__*/_jsxDEV(Alert, {\n          variant: \"danger\",\n          onClose: () => setError(null),\n          dismissible: true,\n          className: \"py-1 px-2 small mb-0\",\n          children: error\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 328,\n          columnNumber: 17\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 327,\n        columnNumber: 13\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 289,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Row, {\n      className: \"chat-display-row\",\n      children: /*#__PURE__*/_jsxDEV(Col, {\n        children: /*#__PURE__*/_jsxDEV(ChatDisplay, {\n          messages: messages,\n          isLoading: isLoading /* Loading anaimation only for AI response, not feedback */\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 338,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 337,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 336,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Row, {\n      className: \"message-input-row sticky-bottom bg-light p-3\",\n      children: /*#__PURE__*/_jsxDEV(Col, {\n        children: /*#__PURE__*/_jsxDEV(MessageInput, {\n          currentMessage: currentMessage,\n          onMessageChange: setCurrentMessage,\n          onSendMessage: handleSendMessage,\n          onGetFeedback: handleGetFeedback,\n          isLoading: isLoading,\n          isGettingFeedback: isGettingFeedback // 傳遞回饋讀取狀態\n          ,\n          disabled: !selectedCharacter || !goal.trim()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 345,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 344,\n        columnNumber: 9\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 343,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 287,\n    columnNumber: 5\n  }, this);\n}\n_s(TrainingRoom, \"oqi9V6Tq0pk0T9QnlQqqTYQDW9E=\");\n_c = TrainingRoom;\nexport default TrainingRoom;\nvar _c;\n$RefreshReg$(_c, \"TrainingRoom\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useCallback","Form","InputGroup","Container","Row","Col","Spinner","Alert","Button","ChatDisplay","MessageInput","sendMessageToOllama","getFeedbackFromOllama","jsxDEV","_jsxDEV","CHAT_HISTORY_PREFIX","FEEDBACK_STORAGE_KEY","TrainingRoom","selectedCharacter","_s","goal","setGoal","messages","setMessages","currentMessage","setCurrentMessage","isLoading","setIsLoading","isGettingFeedback","setIsGettingFeedback","error","setError","currentGoalRef","getStorageKey","trim","goalKey","substring","replace","id","current","storageKey","savedHistory","localStorage","getItem","JSON","parse","e","console","length","setItem","stringify","removeItem","handleClearChat","window","confirm","name","handleSendMessage","newUserMessage","Date","now","sender","text","currentInput","prevMessages","historyForOllama","map","msg","role","content","requestHistory","aiResponseText","newAiMessage","err","errorMsg","message","errorAiMessage","parseFeedback","feedbackText","summary","scores","clarity","empathy","confidence","appropriateness","goalAchievement","summaryMatch","match","summaryOnlyMatch","warn","scoresTextMatch","scoreLines","split","forEach","line","parts","key","toLowerCase","value","score","parseInt","isNaN","Math","max","min","log","handleGetFeedback","filter","m","alert","feedbackRequestMessage","_scores$clarity","_scores$empathy","_scores$confidence","_scores$appropriatene","_scores$goalAchieveme","historyForFeedback","feedbackRawText","feedbackMessage","newFeedbackEntry","timestamp","characterId","characterName","rawFeedback","existingFeedback","errorFeedbackMessage","fluid","className","children","md","Text","fileName","_jsxFileName","lineNumber","columnNumber","Control","type","placeholder","onChange","target","disabled","title","variant","size","onClick","href","preventDefault","xs","onClose","dismissible","onMessageChange","onSendMessage","onGetFeedback","_c","$RefreshReg$"],"sources":["C:/Users/Paul2/onedrive/桌面/llm_dialougue_v4/wingchat-app/src/components/TrainingRoom/TrainingRoom.js"],"sourcesContent":["import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { Form, InputGroup, Container, Row, Col, Spinner, Alert, Button } from 'react-bootstrap';\r\nimport ChatDisplay from './ChatDisplay';\r\nimport MessageInput from './MessageInput';\r\nimport { sendMessageToOllama, getFeedbackFromOllama } from '../../services/ollamaService'; // 引入 API 服務\r\nimport '../../styles/TrainingRoom.css'; // 引入聊天室樣式\r\n\r\n// 本地儲存聊天記錄的 Key 前綴\r\nconst CHAT_HISTORY_PREFIX = 'wingchat_history_';\r\n// 本地儲存回饋的 Key (雖然解析還未完成，但先定義)\r\nconst FEEDBACK_STORAGE_KEY = 'wingchat_feedback';\r\n\r\n\r\nfunction TrainingRoom({ selectedCharacter }) {\r\n  const [goal, setGoal] = useState('');\r\n  const [messages, setMessages] = useState([]);\r\n  const [currentMessage, setCurrentMessage] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isGettingFeedback, setIsGettingFeedback] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const currentGoalRef = useRef(goal);\r\n\r\n  // 產生用於儲存的 key\r\n  const getStorageKey = useCallback(() => {\r\n      if (!selectedCharacter || !goal.trim()) return null;\r\n      const goalKey = goal.trim().substring(0, 50).replace(/[^a-zA-Z0-9-_]/g, '_'); // 允許底線和連字號\r\n      return `${CHAT_HISTORY_PREFIX}${selectedCharacter.id}_${goalKey}`;\r\n  }, [selectedCharacter, goal]);\r\n\r\n  // 加載聊天記錄\r\n  useEffect(() => {\r\n    currentGoalRef.current = goal;\r\n    const storageKey = getStorageKey();\r\n    if (storageKey) {\r\n      const savedHistory = localStorage.getItem(storageKey);\r\n      if (savedHistory) {\r\n        try {\r\n          setMessages(JSON.parse(savedHistory));\r\n        } catch (e) {\r\n          console.error(\"Failed to parse chat history\", e);\r\n          setMessages([]);\r\n        }\r\n      } else {\r\n        setMessages([]);\r\n      }\r\n    } else if (selectedCharacter) {\r\n        setMessages([]);\r\n    }\r\n     setError(null);\r\n  }, [selectedCharacter, goal, getStorageKey]);\r\n\r\n   // 保存聊天記錄\r\n   useEffect(() => {\r\n     const storageKey = getStorageKey();\r\n     if (storageKey && messages.length > 0) {\r\n       localStorage.setItem(storageKey, JSON.stringify(messages));\r\n     }\r\n     else if (storageKey && messages.length === 0) {\r\n         localStorage.removeItem(storageKey);\r\n     }\r\n   }, [messages, getStorageKey]);\r\n\r\n\r\n  // 清除當前目標的聊天記錄\r\n  const handleClearChat = () => {\r\n      if (window.confirm(`確定要清除與 ${selectedCharacter?.name} 關於目標「${goal}」的所有聊天記錄嗎？`)) {\r\n          setMessages([]);\r\n          const storageKey = getStorageKey();\r\n          if (storageKey) {\r\n              localStorage.removeItem(storageKey);\r\n          }\r\n      }\r\n  }\r\n\r\n  // 發送訊息處理\r\n  const handleSendMessage = async () => {\r\n    if (!currentMessage.trim() || !selectedCharacter) return;\r\n    if (!goal.trim()) {\r\n      setError(\"請先設定本次聊天的目標！\");\r\n      return;\r\n    }\r\n    if (isLoading || isGettingFeedback) return;\r\n\r\n    const newUserMessage = {\r\n      id: Date.now(),\r\n      sender: 'user',\r\n      text: currentMessage,\r\n    };\r\n\r\n    const currentInput = currentMessage;\r\n    // 立即更新 UI\r\n    setMessages(prevMessages => [...prevMessages, newUserMessage]);\r\n    setCurrentMessage('');\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const historyForOllama = messages.map(msg => ({\r\n        role: msg.sender === 'user' ? 'user' : 'assistant',\r\n        content: msg.text\r\n      }));\r\n      // 使用最新的 user message (currentInput) 構建傳遞給 API 的歷史\r\n      const requestHistory = [...historyForOllama, { role: 'user', content: currentInput }];\r\n\r\n\r\n      const aiResponseText = await sendMessageToOllama(\r\n        goal,\r\n        requestHistory, // 使用包含最新消息的歷史\r\n        selectedCharacter,\r\n        \"llama3.2:latest\" // <--- 確認使用新模型名稱\r\n      );\r\n\r\n      const newAiMessage = {\r\n        id: Date.now() + 1,\r\n        sender: 'ai',\r\n        text: aiResponseText,\r\n      };\r\n      // 注意：這裡的 setMessages 是基於「請求發起時」的 messages 狀態來添加 AI 回覆\r\n      // 為了確保 user message 肯定在 AI message 之前，我們直接添加在 newUserMessage 之後\r\n      setMessages(prevMessages => [...prevMessages, newAiMessage]);\r\n\r\n    } catch (err) {\r\n      console.error(\"Error contacting Ollama:\", err);\r\n      const errorMsg = err.message || \"與 AI 通訊時發生錯誤。\";\r\n      setError(errorMsg);\r\n      const errorAiMessage = {\r\n        id: Date.now() + 1,\r\n        sender: 'ai',\r\n        text: `🤖 抱歉，處理時遇到問題：${errorMsg}`,\r\n      };\r\n      // 同樣，添加在最新的 user message 之後\r\n       setMessages(prevMessages => [...prevMessages, errorAiMessage]);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // --- TODO: 回饋解析函數 ---\r\n  // 這個函數需要根據 getFeedbackFromOllama 返回的字串格式來解析\r\n  const parseFeedback = (feedbackText) => {\r\n      let summary = \"無法解析回饋摘要。\";\r\n      let scores = {\r\n          clarity: null, empathy: null, confidence: null, appropriateness: null, goalAchievement: null\r\n      };\r\n\r\n      try {\r\n          // 解析摘要\r\n          const summaryMatch = feedbackText.match(/\\[Feedback Summary\\]\\s*([\\s\\S]*?)\\s*\\[Scores\\]/);\r\n          if (summaryMatch && summaryMatch[1]) {\r\n              summary = summaryMatch[1].trim();\r\n          } else {\r\n             // 嘗試備用模式，如果沒有 [Scores] 標籤\r\n              const summaryOnlyMatch = feedbackText.match(/\\[Feedback Summary\\]\\s*([\\s\\S]*)/);\r\n              if (summaryOnlyMatch && summaryOnlyMatch[1]) {\r\n                summary = summaryOnlyMatch[1].trim();\r\n                console.warn(\"Feedback parsing: Only found summary, scores section missing or malformed.\");\r\n              } else {\r\n                console.warn(\"Feedback parsing: Could not find [Feedback Summary] section.\");\r\n                // 如果連摘要都找不到，可能整個回饋都是非結構化的\r\n                summary = feedbackText; // 將整個文本視為摘要\r\n              }\r\n          }\r\n\r\n          // 解析分數\r\n          const scoresTextMatch = feedbackText.match(/\\[Scores\\]\\s*([\\s\\S]*)/);\r\n          if (scoresTextMatch && scoresTextMatch[1]) {\r\n              const scoreLines = scoresTextMatch[1].trim().split('\\n');\r\n              scoreLines.forEach(line => {\r\n                  const parts = line.split(':');\r\n                  if (parts.length === 2) {\r\n                      const key = parts[0].trim().toLowerCase().replace(/\\s+/g, ''); // 轉小寫並移除空格\r\n                      const value = parts[1].trim();\r\n                      if (value.toLowerCase() === 'n/a') {\r\n                          scores[key] = null; // N/A 視為 null\r\n                      } else {\r\n                          const score = parseInt(value, 10);\r\n                          if (!isNaN(score)) {\r\n                              if (key === 'clarity') scores.clarity = Math.max(0, Math.min(100, score));\r\n                              else if (key === 'empathy') scores.empathy = Math.max(0, Math.min(100, score));\r\n                              else if (key === 'confidence') scores.confidence = Math.max(0, Math.min(100, score));\r\n                              else if (key === 'appropriateness') scores.appropriateness = Math.max(0, Math.min(100, score));\r\n                              else if (key === 'goalachievement') scores.goalAchievement = Math.max(0, Math.min(100, score));\r\n                          }\r\n                      }\r\n                  }\r\n              });\r\n          } else if (!summaryOnlyMatch){ // 如果連 [Scores] 都沒匹配到，且不是只有摘要的情況\r\n              console.warn(\"Feedback parsing: Could not find [Scores] section.\");\r\n          }\r\n      } catch (e) {\r\n          console.error(\"Error parsing feedback text:\", e);\r\n          // 出錯時返回原始文本作為摘要，分數為空\r\n          summary = feedbackText;\r\n      }\r\n\r\n      console.log(\"Parsed Feedback:\", { summary, scores });\r\n      return { summary, scores };\r\n  }\r\n  // --- 結束 TODO ---\r\n\r\n\r\n  // 獲取回饋處理\r\n  const handleGetFeedback = async () => {\r\n      if (!selectedCharacter || !goal.trim() || messages.filter(m => m.sender !== 'system').length === 0) { // 確保有非系統消息\r\n          alert(\"請先設定目標、選擇角色並進行至少一輪對話，才能請求回饋。\");\r\n          return;\r\n      }\r\n      if (isLoading || isGettingFeedback) return;\r\n\r\n      setIsGettingFeedback(true);\r\n      setError(null);\r\n      const feedbackRequestMessage = {\r\n          id: Date.now(),\r\n          sender: 'system',\r\n          text: '⏳ 正在向 AI 請求對話回饋...'\r\n      };\r\n      setMessages(prevMessages => [...prevMessages, feedbackRequestMessage]);\r\n\r\n\r\n      try {\r\n          const historyForFeedback = messages\r\n            .filter(msg => msg.sender !== 'system') // 過濾掉系統消息\r\n            .map(msg => ({\r\n                role: msg.sender === 'user' ? 'user' : 'assistant',\r\n                content: msg.text\r\n            }));\r\n\r\n          const feedbackRawText = await getFeedbackFromOllama(\r\n              goal,\r\n              historyForFeedback,\r\n              selectedCharacter,\r\n              \"llama3.2:latest\" // <--- 確認使用新模型名稱\r\n          );\r\n\r\n          // --- TODO: 解析並儲存回饋 ---\r\n          const { summary, scores } = parseFeedback(feedbackRawText);\r\n\r\n          const feedbackMessage = {\r\n              id: Date.now() + 1,\r\n              sender: 'ai',\r\n              // 在聊天中顯示結構化的回饋（或僅顯示摘要）\r\n              text: `💡 **本次對話回饋 (${goal})**\\n\\n**摘要:**\\n${summary}\\n\\n**評分 (0-100):**\\n- 清晰度: ${scores.clarity ?? 'N/A'}\\n- 同理心: ${scores.empathy ?? 'N/A'}\\n- 自信: ${scores.confidence ?? 'N/A'}\\n- 適當性: ${scores.appropriateness ?? 'N/A'}\\n- 目標達成: ${scores.goalAchievement ?? 'N/A'}`\r\n          };\r\n\r\n          // 儲存到 localStorage 供 FeedbackWall 使用\r\n          const newFeedbackEntry = {\r\n              timestamp: Date.now(),\r\n              goal: goal,\r\n              characterId: selectedCharacter.id,\r\n              characterName: selectedCharacter.name,\r\n              scores: scores, // 儲存解析後的分數對象\r\n              summary: summary, // 儲存解析後的摘要\r\n              rawFeedback: feedbackRawText // (可選) 儲存原始文本供調試\r\n          };\r\n          const existingFeedback = JSON.parse(localStorage.getItem(FEEDBACK_STORAGE_KEY) || '[]');\r\n          localStorage.setItem(FEEDBACK_STORAGE_KEY, JSON.stringify([...existingFeedback, newFeedbackEntry]));\r\n          // --- 結束 TODO ---\r\n\r\n\r\n          // 移除\"正在請求\"的訊息，並加入解析後的回饋訊息\r\n          setMessages(prevMessages => [\r\n              ...prevMessages.filter(msg => msg.id !== feedbackRequestMessage.id),\r\n              feedbackMessage\r\n          ]);\r\n\r\n\r\n      } catch (err) {\r\n          console.error(\"Error getting or parsing feedback from Ollama:\", err);\r\n          const errorMsg = err.message || \"無法獲取或處理 AI 回饋。\";\r\n          setError(errorMsg);\r\n          const errorFeedbackMessage = {\r\n            id: Date.now() + 1,\r\n            sender: 'ai',\r\n            text: `🤖 抱歉，獲取回饋時遇到問題：${errorMsg}`\r\n          };\r\n           setMessages(prevMessages => [\r\n                ...prevMessages.filter(msg => msg.id !== feedbackRequestMessage.id),\r\n                errorFeedbackMessage\r\n           ]);\r\n      } finally {\r\n          setIsGettingFeedback(false);\r\n      }\r\n  };\r\n\r\n\r\n  return (\r\n    <Container fluid className=\"training-room-container vh-100\">\r\n      {/* --- 目標輸入與角色資訊 --- */}\r\n      <Row className=\"goal-input-row bg-light p-2 mb-2 sticky-top shadow-sm\">\r\n        <Col md={7}>\r\n          <InputGroup>\r\n            <InputGroup.Text>🎯</InputGroup.Text>\r\n            <Form.Control\r\n              type=\"text\"\r\n              placeholder={selectedCharacter ? \"輸入本次社交訓練目標...\" : \"請先選擇角色...\"}\r\n              value={goal}\r\n              onChange={(e) => setGoal(e.target.value)}\r\n              disabled={!selectedCharacter || isLoading || isGettingFeedback}\r\n              aria-label=\"聊天目標\"\r\n            />\r\n          </InputGroup>\r\n        </Col>\r\n        <Col md={5} className=\"d-flex align-items-center justify-content-md-end mt-2 mt-md-0\">\r\n          {selectedCharacter ? (\r\n            <div className=\"d-flex align-items-center\">\r\n                <span className=\"text-muted me-3 text-truncate\" title={`與 ${selectedCharacter.name} 訓練中`}>\r\n                    與 <strong>{selectedCharacter.name}</strong> 訓練中\r\n                 </span>\r\n                <Button\r\n                    variant=\"outline-secondary\"\r\n                    size=\"sm\"\r\n                    onClick={handleClearChat}\r\n                    disabled={messages.length === 0 || isLoading || isGettingFeedback}\r\n                    title={`清除關於目標 \"${goal}\" 的聊天記錄`}\r\n                >\r\n                    <i className=\"bi bi-trash3 me-1\"></i> 清除記錄\r\n                </Button>\r\n            </div>\r\n\r\n          ) : (\r\n            <Alert variant=\"warning\" className=\"p-1 mb-0 small w-100 text-center\">\r\n              請先至 <a href=\"#\" onClick={(e) => { e.preventDefault(); alert('請點擊上方導覽列的「角色館」'); }}>角色館</a> 選擇或新增角色\r\n            </Alert>\r\n          )}\r\n        </Col>\r\n        {error && (\r\n            <Col xs={12} className=\"mt-2\">\r\n                <Alert variant=\"danger\" onClose={() => setError(null)} dismissible className=\"py-1 px-2 small mb-0\">\r\n                    {error}\r\n                </Alert>\r\n            </Col>\r\n        )}\r\n      </Row>\r\n\r\n      {/* --- 聊天顯示區域 --- */}\r\n      <Row className=\"chat-display-row\">\r\n        <Col>\r\n          <ChatDisplay messages={messages} isLoading={isLoading /* Loading anaimation only for AI response, not feedback */} />\r\n        </Col>\r\n      </Row>\r\n\r\n      {/* --- 訊息輸入區域 --- */}\r\n      <Row className=\"message-input-row sticky-bottom bg-light p-3\">\r\n        <Col>\r\n          <MessageInput\r\n            currentMessage={currentMessage}\r\n            onMessageChange={setCurrentMessage}\r\n            onSendMessage={handleSendMessage}\r\n            onGetFeedback={handleGetFeedback}\r\n            isLoading={isLoading}\r\n            isGettingFeedback={isGettingFeedback} // 傳遞回饋讀取狀態\r\n            disabled={!selectedCharacter || !goal.trim()}\r\n          />\r\n        </Col>\r\n      </Row>\r\n    </Container>\r\n  );\r\n}\r\n\r\nexport default TrainingRoom;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}