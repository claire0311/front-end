{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Paul2\\\\Downloads\\\\front-end-main (5)\\\\front-end-main\\\\src\\\\components\\\\TrainingRoom\\\\ChatDisplay.js\",\n  _s = $RefreshSig$();\n// src/components/TrainingRoom/ChatDisplay.js (修正版)\n\nimport React, { useRef, useEffect, useLayoutEffect } from 'react';\nimport { Spinner, Alert } from 'react-bootstrap';\nimport ChatMessage from './ChatMessage';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nfunction ChatDisplay({\n  messages,\n  isLoading\n}) {\n  _s();\n  const chatEndRef = useRef(null);\n  const scrollContainerRef = useRef(null); // Ref 指向 .chat-display-area\n  const prevMessagesLengthRef = useRef(messages.length);\n\n  // useLayoutEffect 用於在新消息來時智能滾動\n  useLayoutEffect(() => {\n    var _scrollContainerRef$c;\n    // *** 獲取父元素 (.chat-display-row) 來檢查和控制滾動 ***\n    const scrollableElement = (_scrollContainerRef$c = scrollContainerRef.current) === null || _scrollContainerRef$c === void 0 ? void 0 : _scrollContainerRef$c.parentElement;\n    if (!scrollableElement) return;\n    const isScrollable = scrollableElement.scrollHeight > scrollableElement.clientHeight;\n    const messagesWereAdded = messages.length > prevMessagesLengthRef.current;\n    const scrollThreshold = 100; // 接近底部的容錯像素\n    let isNearBottom = true;\n    if (isScrollable) {\n      isNearBottom = scrollableElement.scrollHeight - scrollableElement.scrollTop <= scrollableElement.clientHeight + scrollThreshold;\n    }\n\n    // 只有當新訊息加入且用戶接近底部時才滾動\n    if (messagesWereAdded && isNearBottom) {\n      const timer = setTimeout(() => {\n        var _chatEndRef$current;\n        (_chatEndRef$current = chatEndRef.current) === null || _chatEndRef$current === void 0 ? void 0 : _chatEndRef$current.scrollIntoView({\n          behavior: \"smooth\",\n          block: \"end\"\n        });\n      }, 50); // 短延遲確保渲染完成\n      return () => clearTimeout(timer);\n    }\n\n    // 更新上次訊息數量\n    prevMessagesLengthRef.current = messages.length;\n  }, [messages]); // 依賴 messages 陣列\n\n  return (\n    /*#__PURE__*/\n    // *** 這個 div (chat-display-area) 不再設置 height 或 overflow ***\n    _jsxDEV(\"div\", {\n      ref: scrollContainerRef // Ref 仍然指向這個 div\n      ,\n      className: \"chat-display-area\",\n      children: [messages.length === 0 && !isLoading && /*#__PURE__*/_jsxDEV(Alert, {\n        variant: \"info\",\n        className: \"text-center small p-2 mx-auto mt-2\",\n        style: {\n          maxWidth: '80%',\n          flexShrink: 0\n        },\n        children: \"\\u8A2D\\u5B9A\\u597D\\u76EE\\u6A19\\u5F8C\\uFF0C\\u5C31\\u53EF\\u4EE5\\u958B\\u59CB\\u548C AI \\u5C0D\\u8A71\\u7DF4\\u7FD2\\u56C9\\uFF01\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 48,\n        columnNumber: 9\n      }, this), messages.map(msg =>\n      /*#__PURE__*/\n      // 傳遞 isFeedback prop\n      _jsxDEV(ChatMessage, {\n        sender: msg.sender,\n        text: msg.text,\n        isFeedback: msg.isFeedback\n      }, msg.id, false, {\n        fileName: _jsxFileName,\n        lineNumber: 56,\n        columnNumber: 9\n      }, this)), isLoading && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"d-flex justify-content-center align-items-center my-2 p-2 text-muted\",\n        style: {\n          flexShrink: 0\n        },\n        children: [/*#__PURE__*/_jsxDEV(Spinner, {\n          animation: \"border\",\n          role: \"status\",\n          size: \"sm\",\n          className: \"me-2\",\n          children: /*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"visually-hidden\",\n            children: \"Loading...\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 63,\n            columnNumber: 14\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 62,\n          columnNumber: 12\n        }, this), \"AI \\u6B63\\u5728\\u601D\\u8003...\"]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 61,\n        columnNumber: 10\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        ref: chatEndRef,\n        style: {\n          height: '1px',\n          flexShrink: 0\n        }\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 70,\n        columnNumber: 7\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 42,\n      columnNumber: 5\n    }, this)\n  );\n}\n_s(ChatDisplay, \"fOuVhriaq3M/2LuacOb+9JJGDbo=\");\n_c = ChatDisplay;\nexport default ChatDisplay;\nvar _c;\n$RefreshReg$(_c, \"ChatDisplay\");","map":{"version":3,"names":["React","useRef","useEffect","useLayoutEffect","Spinner","Alert","ChatMessage","jsxDEV","_jsxDEV","ChatDisplay","messages","isLoading","_s","chatEndRef","scrollContainerRef","prevMessagesLengthRef","length","_scrollContainerRef$c","scrollableElement","current","parentElement","isScrollable","scrollHeight","clientHeight","messagesWereAdded","scrollThreshold","isNearBottom","scrollTop","timer","setTimeout","_chatEndRef$current","scrollIntoView","behavior","block","clearTimeout","ref","className","children","variant","style","maxWidth","flexShrink","fileName","_jsxFileName","lineNumber","columnNumber","map","msg","sender","text","isFeedback","id","animation","role","size","height","_c","$RefreshReg$"],"sources":["C:/Users/Paul2/Downloads/front-end-main (5)/front-end-main/src/components/TrainingRoom/ChatDisplay.js"],"sourcesContent":["// src/components/TrainingRoom/ChatDisplay.js (修正版)\n\nimport React, { useRef, useEffect, useLayoutEffect } from 'react';\nimport { Spinner, Alert } from 'react-bootstrap';\nimport ChatMessage from './ChatMessage';\n\nfunction ChatDisplay({ messages, isLoading }) {\n  const chatEndRef = useRef(null);\n  const scrollContainerRef = useRef(null); // Ref 指向 .chat-display-area\n  const prevMessagesLengthRef = useRef(messages.length);\n\n  // useLayoutEffect 用於在新消息來時智能滾動\n  useLayoutEffect(() => {\n    // *** 獲取父元素 (.chat-display-row) 來檢查和控制滾動 ***\n    const scrollableElement = scrollContainerRef.current?.parentElement;\n    if (!scrollableElement) return;\n\n    const isScrollable = scrollableElement.scrollHeight > scrollableElement.clientHeight;\n    const messagesWereAdded = messages.length > prevMessagesLengthRef.current;\n    const scrollThreshold = 100; // 接近底部的容錯像素\n    let isNearBottom = true;\n\n    if (isScrollable) {\n      isNearBottom = scrollableElement.scrollHeight - scrollableElement.scrollTop <= scrollableElement.clientHeight + scrollThreshold;\n    }\n\n    // 只有當新訊息加入且用戶接近底部時才滾動\n    if (messagesWereAdded && isNearBottom) {\n      const timer = setTimeout(() => {\n        chatEndRef.current?.scrollIntoView({ behavior: \"smooth\", block: \"end\" });\n      }, 50); // 短延遲確保渲染完成\n      return () => clearTimeout(timer);\n    }\n\n    // 更新上次訊息數量\n    prevMessagesLengthRef.current = messages.length;\n\n  }, [messages]); // 依賴 messages 陣列\n\n  return (\n    // *** 這個 div (chat-display-area) 不再設置 height 或 overflow ***\n    <div\n      ref={scrollContainerRef} // Ref 仍然指向這個 div\n      className=\"chat-display-area\"\n    >\n      {/* 空狀態提示 */}\n      {messages.length === 0 && !isLoading && (\n        <Alert variant=\"info\" className=\"text-center small p-2 mx-auto mt-2\" style={{maxWidth: '80%', flexShrink: 0 }}>\n          設定好目標後，就可以開始和 AI 對話練習囉！\n        </Alert>\n      )}\n\n      {/* 訊息列表 */}\n      {messages.map((msg) => (\n        // 傳遞 isFeedback prop\n        <ChatMessage key={msg.id} sender={msg.sender} text={msg.text} isFeedback={msg.isFeedback} />\n      ))}\n\n      {/* 加載指示器 */}\n      {isLoading && (\n         <div className=\"d-flex justify-content-center align-items-center my-2 p-2 text-muted\" style={{ flexShrink: 0 }}>\n           <Spinner animation=\"border\" role=\"status\" size=\"sm\" className=\"me-2\">\n             <span className=\"visually-hidden\">Loading...</span>\n           </Spinner>\n           AI 正在思考...\n         </div>\n       )}\n\n      {/* 滾動目標錨點 */}\n      <div ref={chatEndRef} style={{ height: '1px', flexShrink: 0 }} />\n    </div>\n  );\n}\n\nexport default ChatDisplay;"],"mappings":";;AAAA;;AAEA,OAAOA,KAAK,IAAIC,MAAM,EAAEC,SAAS,EAAEC,eAAe,QAAQ,OAAO;AACjE,SAASC,OAAO,EAAEC,KAAK,QAAQ,iBAAiB;AAChD,OAAOC,WAAW,MAAM,eAAe;AAAC,SAAAC,MAAA,IAAAC,OAAA;AAExC,SAASC,WAAWA,CAAC;EAAEC,QAAQ;EAAEC;AAAU,CAAC,EAAE;EAAAC,EAAA;EAC5C,MAAMC,UAAU,GAAGZ,MAAM,CAAC,IAAI,CAAC;EAC/B,MAAMa,kBAAkB,GAAGb,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC;EACzC,MAAMc,qBAAqB,GAAGd,MAAM,CAACS,QAAQ,CAACM,MAAM,CAAC;;EAErD;EACAb,eAAe,CAAC,MAAM;IAAA,IAAAc,qBAAA;IACpB;IACA,MAAMC,iBAAiB,IAAAD,qBAAA,GAAGH,kBAAkB,CAACK,OAAO,cAAAF,qBAAA,uBAA1BA,qBAAA,CAA4BG,aAAa;IACnE,IAAI,CAACF,iBAAiB,EAAE;IAExB,MAAMG,YAAY,GAAGH,iBAAiB,CAACI,YAAY,GAAGJ,iBAAiB,CAACK,YAAY;IACpF,MAAMC,iBAAiB,GAAGd,QAAQ,CAACM,MAAM,GAAGD,qBAAqB,CAACI,OAAO;IACzE,MAAMM,eAAe,GAAG,GAAG,CAAC,CAAC;IAC7B,IAAIC,YAAY,GAAG,IAAI;IAEvB,IAAIL,YAAY,EAAE;MAChBK,YAAY,GAAGR,iBAAiB,CAACI,YAAY,GAAGJ,iBAAiB,CAACS,SAAS,IAAIT,iBAAiB,CAACK,YAAY,GAAGE,eAAe;IACjI;;IAEA;IACA,IAAID,iBAAiB,IAAIE,YAAY,EAAE;MACrC,MAAME,KAAK,GAAGC,UAAU,CAAC,MAAM;QAAA,IAAAC,mBAAA;QAC7B,CAAAA,mBAAA,GAAAjB,UAAU,CAACM,OAAO,cAAAW,mBAAA,uBAAlBA,mBAAA,CAAoBC,cAAc,CAAC;UAAEC,QAAQ,EAAE,QAAQ;UAAEC,KAAK,EAAE;QAAM,CAAC,CAAC;MAC1E,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC;MACR,OAAO,MAAMC,YAAY,CAACN,KAAK,CAAC;IAClC;;IAEA;IACAb,qBAAqB,CAACI,OAAO,GAAGT,QAAQ,CAACM,MAAM;EAEjD,CAAC,EAAE,CAACN,QAAQ,CAAC,CAAC,CAAC,CAAC;;EAEhB;IAAA;IACE;IACAF,OAAA;MACE2B,GAAG,EAAErB,kBAAmB,CAAC;MAAA;MACzBsB,SAAS,EAAC,mBAAmB;MAAAC,QAAA,GAG5B3B,QAAQ,CAACM,MAAM,KAAK,CAAC,IAAI,CAACL,SAAS,iBAClCH,OAAA,CAACH,KAAK;QAACiC,OAAO,EAAC,MAAM;QAACF,SAAS,EAAC,oCAAoC;QAACG,KAAK,EAAE;UAACC,QAAQ,EAAE,KAAK;UAAEC,UAAU,EAAE;QAAE,CAAE;QAAAJ,QAAA,EAAC;MAE/G;QAAAK,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAO,CACR,EAGAnC,QAAQ,CAACoC,GAAG,CAAEC,GAAG;MAAA;MAChB;MACAvC,OAAA,CAACF,WAAW;QAAc0C,MAAM,EAAED,GAAG,CAACC,MAAO;QAACC,IAAI,EAAEF,GAAG,CAACE,IAAK;QAACC,UAAU,EAAEH,GAAG,CAACG;MAAW,GAAvEH,GAAG,CAACI,EAAE;QAAAT,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAmE,CAC5F,CAAC,EAGDlC,SAAS,iBACPH,OAAA;QAAK4B,SAAS,EAAC,sEAAsE;QAACG,KAAK,EAAE;UAAEE,UAAU,EAAE;QAAE,CAAE;QAAAJ,QAAA,gBAC7G7B,OAAA,CAACJ,OAAO;UAACgD,SAAS,EAAC,QAAQ;UAACC,IAAI,EAAC,QAAQ;UAACC,IAAI,EAAC,IAAI;UAAClB,SAAS,EAAC,MAAM;UAAAC,QAAA,eAClE7B,OAAA;YAAM4B,SAAS,EAAC,iBAAiB;YAAAC,QAAA,EAAC;UAAU;YAAAK,QAAA,EAAAC,YAAA;YAAAC,UAAA;YAAAC,YAAA;UAAA,OAAM;QAAC;UAAAH,QAAA,EAAAC,YAAA;UAAAC,UAAA;UAAAC,YAAA;QAAA,OAC5C,CAAC,kCAEZ;MAAA;QAAAH,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAK,CACN,eAGFrC,OAAA;QAAK2B,GAAG,EAAEtB,UAAW;QAAC0B,KAAK,EAAE;UAAEgB,MAAM,EAAE,KAAK;UAAEd,UAAU,EAAE;QAAE;MAAE;QAAAC,QAAA,EAAAC,YAAA;QAAAC,UAAA;QAAAC,YAAA;MAAA,OAAE,CAAC;IAAA;MAAAH,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OAC9D;EAAC;AAEV;AAACjC,EAAA,CAlEQH,WAAW;AAAA+C,EAAA,GAAX/C,WAAW;AAoEpB,eAAeA,WAAW;AAAC,IAAA+C,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}